# Read huginn/LICENSE.md file for copyright and licensing information.

$(eval DIR_ROOT?=$(subst /Makefile.mk.in,,$(lastword $(realpath $(foreach DIR,$(subst /, ,$(CURDIR)), $(eval DIR_ROOT_TEST=$(DIR_ROOT_TEST)/$(DIR))$(DIR_ROOT_TEST)/Makefile.mk.in)))))
PRJNAME        = huginn
VERSION        = 0
SUBVERSION     = 0
EXTRAVERSION   = 3
include $(DIR_ROOT)/_aux/mk/00_sanity.mk
include $(DIR_ROOT)/_aux/mk/10_basic.mk
include $(DIR_BUILD)/configure.mk

override EXTRA_LIBS:= $(filter-out -lyaal_hdata% -lyaal_hconsole%,$(EXTRA_LIBS))

LIBS           = pthread
$(eval $(call NEW_TARGET,huginn,src,,@RDYNAMIC@))
DO_@DO_TARGET@=1
EXEC_NAME    = 1exec

include $(DIR_ROOT)/_aux/inc-helper-pre.mk

override CXXFLAGS+= @DEFS@
override LXXFLAGS+= $(NO_AS_NEEDED)

include $(DIR_ROOT)/_aux/inc-helper-post.mk

CLOU_BIN=$(DIR_BUILD)/$(PRJNAME)/$(EXEC_NAME)
CLOU_CONF=$(DIR_ROOT)/$(PRJNAME)rc:$(PRJNAME)/rc $(DIR_ROOT)/src/init.sample:$(PRJNAME)/init $(DIR_ROOT)/src/init.shell.sample:$(PRJNAME)/init.shell
CLOU_SHARE=$(DIR_ROOT)/_deploy/jupyter-deploy $(DIR_ROOT)/src/ihuginn.py $(DIR_ROOT)/src/codemirror.js $(DIR_ROOT)/src/jupyter.css $(DIR_ROOT)/src/pygment.py $(DIR_ROOT)/src/kernel.json
CLOU_MODULES=$(DIR_ROOT)/packages/*.hgn
CLOU_DOC=$(DIR_ROOT)/README.md $(DIR_ROOT)/LICENSE.md
CLOU_MAN=$(DIR_ROOT)/build/doc/$(PRJNAME).1

install-local:
	@$(call invoke,ln -sf $(PRJNAME) $(DIR_BIN)/hgnsh && ln -sf $(PRJNAME).1 $(DIR_MAN)/man1/hgnsh.1)

uninstall-local:
	@$(call invoke,rm -f $(DIR_BIN)/hgnsh $(DIR_MAN)/man1/hgnsh.1)

test: release
	@cd ${DIR_ROOT} && \
	HUGINNPATH=${DIR_ROOT}/packages ./build/release/huginn/1exec Testing tests && \
	TARGET=release ./tests/shell-tests.sh

